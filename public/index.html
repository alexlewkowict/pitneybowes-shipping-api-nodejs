<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PB Presort Shipping</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì¶</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-card: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --error: #ef4444;
            --border: #2a2a2a;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Password Screen */
        #password-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #password-screen.hidden {
            display: none;
        }

        .password-container {
            text-align: center;
            max-width: 400px;
            padding: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
        }

        .password-container h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .password-container p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .password-input-group {
            margin-bottom: 1rem;
        }

        .password-input-group input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .password-input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .password-error {
            color: var(--error);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
        }

        .password-error.show {
            display: block;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 95%;
            width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Main Container */
        .container {
            max-width: 95%;
            width: 100%;
            margin: 0 auto;
            padding: 2rem;
        }

        .hero {
            text-align: center;
            margin-bottom: 4rem;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .hero .gradient-text {
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Form Container */
        .form-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .section-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .section-header p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .form-grid.full-width {
            grid-template-columns: 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-primary);
        }

        .required {
            color: var(--error);
        }

        /* Buttons */
        .btn {
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
            border-color: var(--accent);
        }

        /* Loading State */
        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin: 2rem 0;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Result Display */
        .result {
            display: none;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .result.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .result.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .result h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .result-details {
            display: grid;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--bg-card);
            border-radius: 6px;
        }

        .result-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .result-value {
            font-weight: 600;
        }

        .result-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .btn-result {
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.2s;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-download {
            background: var(--success);
            color: white;
        }

        .btn-download:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-view-payload {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-view-payload:hover {
            background: var(--bg-primary);
            border-color: var(--accent);
        }

        /* Payload Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
            padding: 2rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            font-size: 1.5rem;
        }

        .modal-close {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-primary);
            border-color: var(--accent);
        }

        .payload-display {
            background: var(--bg-primary);
            padding: 1.5rem;
            border-radius: 8px;
            overflow: auto;
        }

        .payload-display pre {
            margin: 0;
            color: var(--text-primary);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            border-top: 1px solid var(--border);
            margin-top: 4rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 2rem 1rem;
            }

            header {
                padding: 1rem;
            }

            .result-actions {
                flex-direction: column;
            }

            .btn-result {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Password Screen -->
    <div id="password-screen">
        <div class="password-container">
            <h1>üîí Secure Access</h1>
            <p>Enter password to access PB Presort Shipping</p>
            <div class="password-input-group">
                <input type="password" id="password-input" placeholder="Enter password" autocomplete="off">
                <div class="password-error" id="password-error">Incorrect password. Try again.</div>
            </div>
            <button class="btn btn-primary" onclick="checkPassword()">Unlock</button>
        </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="main-app" style="display: none;">
        <header>
            <div class="header-content">
                <div class="logo">üì¶ PB Presort</div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="showPage('shipment')">üì¶ Shipments</button>
                    <button class="btn btn-secondary" onclick="showPage('ratecard')">üí∞ Rate Card</button>
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>

        <!-- Shipment Page -->
        <div id="shipment-page" class="container">
            <div class="hero">
                <h1>Create <span class="gradient-text">Presort Shipment</span></h1>
            </div>

            <form id="shipment-form">
                <!-- Addresses -->
                <div class="form-container">
                    <div class="section-header">
                        <h2>üìç Addresses</h2>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>From Name <span class="required">*</span></label>
                            <input type="text" name="fromName" value="John Smith" required>
                        </div>
                        <div class="form-group">
                            <label>To Name <span class="required">*</span></label>
                            <input type="text" name="toName" value="Mary Jones" required>
                        </div>
                        <div class="form-group">
                            <label>From Company</label>
                            <input type="text" name="fromCompany" value="Supplies">
                        </div>
                        <div class="form-group">
                            <label>To Company</label>
                            <input type="text" name="toCompany" value="Shop">
                        </div>
                        <div class="form-group">
                            <label>From Address <span class="required">*</span></label>
                            <input type="text" name="fromAddress" value="1 Federal St" required>
                        </div>
                        <div class="form-group">
                            <label>To Address <span class="required">*</span></label>
                            <input type="text" name="toAddress" value="1 Federal St" required>
                        </div>
                        <div class="form-group">
                            <label>From City <span class="required">*</span></label>
                            <input type="text" name="fromCity" value="Boston" required>
                        </div>
                        <div class="form-group">
                            <label>To City <span class="required">*</span></label>
                            <input type="text" name="toCity" value="Boston" required>
                        </div>
                        <div class="form-group">
                            <label>From State <span class="required">*</span></label>
                            <input type="text" name="fromState" value="MA" maxlength="2" required>
                        </div>
                        <div class="form-group">
                            <label>To State <span class="required">*</span></label>
                            <input type="text" name="toState" value="MA" maxlength="2" required>
                        </div>
                        <div class="form-group">
                            <label>From Zip <span class="required">*</span></label>
                            <input type="text" name="fromZip" value="02110" required>
                        </div>
                        <div class="form-group">
                            <label>To Zip <span class="required">*</span></label>
                            <input type="text" name="toZip" value="02110" required>
                        </div>
                        <div class="form-group">
                            <label>From Phone</label>
                            <input type="tel" name="fromPhone" value="303-555-0000">
                        </div>
                        <div class="form-group">
                            <label>To Phone</label>
                            <input type="tel" name="toPhone" value="620-555-0000">
                        </div>
                        <div class="form-group">
                            <label>From Email</label>
                            <input type="email" name="fromEmail" value="john@example.com">
                        </div>
                        <div class="form-group">
                            <label>To Email</label>
                            <input type="email" name="toEmail" value="mary@example.com">
                        </div>
                    </div>
                </div>

                <!-- Package & Permit -->
                <div class="form-container">
                    <div class="section-header">
                        <h2>üì¶ Package & Permit</h2>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Service <span class="required">*</span></label>
                            <select name="serviceId" required>
                                <option value="STANDARD" selected>STANDARD - Standard Mail</option>
                                <option value="FCM">FCM - First Class Mail</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Parcel Type <span class="required">*</span></label>
                            <select name="parcelType" required>
                                <option value="LGENV" selected>LGENV - Large Envelope</option>
                                <option value="PKG">PKG - Package</option>
                                <option value="LETTER">LETTER - Letter</option>
                                <option value="FLAT">FLAT - Flat</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Weight (oz) <span class="required">*</span></label>
                            <input type="number" name="weight" value="3" step="0.1" min="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Label Size <span class="required">*</span></label>
                            <select name="labelSize" required>
                                <option value="DOC_6X4" selected>6" x 4"</option>
                                <option value="DOC_8X11">8.5" x 11"</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Length (in) <span class="required">*</span></label>
                            <input type="number" name="length" value="5" step="0.1" min="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Width (in) <span class="required">*</span></label>
                            <input type="number" name="width" value="0.25" step="0.01" min="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Height (in) <span class="required">*</span></label>
                            <input type="number" name="height" value="7" step="0.1" min="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Shipper ID <span class="required">*</span></label>
                            <input type="text" name="shipperId" value="3800270633" required>
                        </div>
                        <div class="form-group">
                            <label>Permit Number <span class="required">*</span></label>
                            <input type="text" name="permitNumber" value="SHFL" required>
                        </div>
                        <div class="form-group">
                            <label>Permit City <span class="required">*</span></label>
                            <input type="text" name="permitCity" value="FOX VALLEY" required>
                        </div>
                        <div class="form-group">
                            <label>Permit State <span class="required">*</span></label>
                            <input type="text" name="permitState" value="IL" maxlength="2" required>
                        </div>
                        <div class="form-group">
                            <label>Custom Message 1</label>
                            <input type="text" name="customMessage1" value="Order 123456" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label>Custom Message 2</label>
                            <input type="text" name="customMessage2" maxlength="50">
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div style="text-align: center;">
                    <button type="submit" class="btn btn-primary">
                        üöÄ Create Shipment
                    </button>
                </div>
            </form>

            <!-- Loading State -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <span>Creating your shipment...</span>
            </div>

            <!-- Result Display -->
            <div id="result" class="result">
                <h3 id="result-title"></h3>
                <div id="result-message"></div>
                <div id="result-details" class="result-details"></div>
            </div>
        </div>

        <footer>
            <p></p>
        </footer>
        </div>

        <!-- Rate Card Page -->
        <div id="ratecard-page" class="container" style="display: none;">
            <div class="hero">
                <h1><span class="gradient-text">Rate Card</span> Management</h1>
            </div>

            <div class="form-container">
                <div class="section-header">
                    <h2>üí∞ USPS Marketing Mail Commercial Flats</h2>
                    <p>Pricing includes postage, processing and logistics. Pricing is subject to change.</p>
                </div>

                <div style="margin-bottom: 2rem;">
                    <button class="btn btn-primary" onclick="addRateTier()">‚ûï Add Tier</button>
                    <button class="btn btn-secondary" onclick="resetRateCard()">üîÑ Reset to Default</button>
                    <button class="btn btn-secondary" onclick="saveRateCard()">üíæ Save Changes</button>
                </div>

                <div style="overflow-x: auto;">
                    <table id="rate-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--bg-secondary); border-bottom: 2px solid var(--border);">
                                <th style="padding: 1rem; text-align: left;">Weight Not Over (oz)</th>
                                <th style="padding: 1rem; text-align: left;">Price ($)</th>
                                <th style="padding: 1rem; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rate-table-body">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
                    <p style="color: var(--text-secondary); font-size: 0.875rem; line-height: 1.6;">
                        <strong>Note:</strong> Pricing includes postage, processing and logistics. Mail without a valid delivery address may be returned or mailed at the retail USPS First Class Mail¬Æ Large Envelope rate. Booklets and large envelopes mailed at the retail rate may be subject to additional fees. Mail is subject to physical and content restrictions. Please speak with your account representative for additional details. Pricing is subject to change.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Payload Modal -->
    <div id="payload-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Payload</h3>
                <button class="modal-close" onclick="closeModal()">Close</button>
            </div>
            <div class="payload-display">
                <pre id="payload-content"></pre>
            </div>
        </div>
    </div>

    <script>
        // Store payloads
        let lastRequestPayload = null;
        let lastResponsePayload = null;
        let lastLabelUrl = null;

        // Default Rate Card
        const DEFAULT_RATE_CARD = [
            { weight: 1, price: 1.19 },
            { weight: 2, price: 1.19 },
            { weight: 3, price: 1.19 },
            { weight: 4, price: 1.19 },
            { weight: 5, price: 1.24 },
            { weight: 6, price: 1.29 },
            { weight: 7, price: 1.34 },
            { weight: 8, price: 1.39 },
            { weight: 9, price: 1.44 },
            { weight: 10, price: 1.49 },
            { weight: 11, price: 1.54 },
            { weight: 12, price: 1.59 },
            { weight: 13, price: 1.64 },
            { weight: 14, price: 1.69 },
            { weight: 15, price: 1.74 },
            { weight: 15.99, price: 1.79 }
        ];

        // Load rate card from localStorage or use default
        let rateCard = JSON.parse(localStorage.getItem('rateCard')) || [...DEFAULT_RATE_CARD];

        // Password Protection
        const CORRECT_PASSWORD = 'yolo';
        
        function checkPassword() {
            const input = document.getElementById('password-input');
            const error = document.getElementById('password-error');
            
            if (input.value === CORRECT_PASSWORD) {
                sessionStorage.setItem('authenticated', 'true');
                document.getElementById('password-screen').classList.add('hidden');
                document.getElementById('main-app').style.display = 'block';
                error.classList.remove('show');
            } else {
                error.classList.add('show');
                input.value = '';
                input.focus();
            }
        }

        function logout() {
            sessionStorage.removeItem('authenticated');
            document.getElementById('password-screen').classList.remove('hidden');
            document.getElementById('main-app').style.display = 'none';
        }

        // Check if already authenticated
        if (sessionStorage.getItem('authenticated') === 'true') {
            document.getElementById('password-screen').classList.add('hidden');
            document.getElementById('main-app').style.display = 'block';
            loadRateCardTable();
        }

        // Allow Enter key to submit password
        document.getElementById('password-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // Form Submission
        document.getElementById('shipment-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('result').classList.remove('show');
            document.querySelector('.btn-primary').disabled = true;

            // Store request payload
            lastRequestPayload = data;

            // Send flat form data - backend will transform it
            // Make API call
            try {
                const response = await fetch('/api/create-shipment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                let result;

                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error(`API returned non-JSON response. Status: ${response.status}. Response: ${text.substring(0, 200)}`);
                }

                // Store response payload
                lastResponsePayload = result;
                if (result.data && result.data.documents && result.data.documents[0]) {
                    lastLabelUrl = result.data.documents[0].contents;
                }

                document.getElementById('loading').classList.remove('active');
                document.querySelector('.btn-primary').disabled = false;

                if (result.success) {
                    showResult('success', '‚úÖ Shipment Created!', result);
                } else {
                    showResult('error', '‚ùå Shipment Failed', result);
                }
            } catch (error) {
                document.getElementById('loading').classList.remove('active');
                document.querySelector('.btn-primary').disabled = false;
                showResult('error', '‚ùå Request Failed', { error: error.message });
            }
        });

        function showResult(type, title, data) {
            const resultDiv = document.getElementById('result');
            const titleDiv = document.getElementById('result-title');
            const messageDiv = document.getElementById('result-message');
            const detailsDiv = document.getElementById('result-details');

            resultDiv.className = `result ${type} show`;
            titleDiv.textContent = title;
            messageDiv.innerHTML = '';

            if (type === 'success') {
                const shipment = data.data || {};
                const tracking = shipment.parcelTrackingNumber || 'N/A';
                const shipmentId = shipment.shipmentId || 'N/A';
                const rate = shipment.rates && shipment.rates[0] ? shipment.rates[0] : {};
                const charge = rate.totalCarrierCharge || 0;
                
                // Calculate rate from rate card
                const weight = lastRequestPayload ? parseFloat(lastRequestPayload.weight) : 0;
                const calculatedRate = calculateRateFromCard(weight);

                detailsDiv.innerHTML = `
                    <div class="result-item">
                        <span class="result-label">Shipment ID</span>
                        <span class="result-value">${shipmentId}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Tracking Number</span>
                        <span class="result-value">${tracking}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Weight</span>
                        <span class="result-value">${weight} oz</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Rate Card Price</span>
                        <span class="result-value" style="color: var(--success); font-size: 1.25rem;">$${calculatedRate.toFixed(2)}</span>
                    </div>
                    ${charge > 0 ? `<div class="result-item">
                        <span class="result-label">API Charge (Reference)</span>
                        <span class="result-value" style="color: var(--text-secondary);">$${charge.toFixed(2)}</span>
                    </div>` : ''}
                    <div class="result-actions">
                        ${lastLabelUrl ? `<a href="${lastLabelUrl}" target="_blank" class="btn-result btn-download">üìÑ Download Label</a>` : ''}
                        <button onclick="viewPayload('request')" class="btn-result btn-view-payload">üì§ View Request</button>
                        <button onclick="viewPayload('response')" class="btn-result btn-view-payload">üì• View Response</button>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `<p style="color: var(--error);">${data.error || 'Unknown error occurred'}</p>`;
                if (data.details) {
                    messageDiv.innerHTML += `<p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">${data.details}</p>`;
                }
                detailsDiv.innerHTML = `
                    <div class="result-actions">
                        <button onclick="viewPayload('request')" class="btn-result btn-view-payload">üì§ View Request</button>
                        <button onclick="viewPayload('response')" class="btn-result btn-view-payload">üì• View Response</button>
                    </div>
                `;
            }

            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function viewPayload(type) {
            const modal = document.getElementById('payload-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('payload-content');

            if (type === 'request') {
                title.textContent = 'üì§ Request Payload';
                content.textContent = JSON.stringify(lastRequestPayload, null, 2);
            } else {
                title.textContent = 'üì• Response Payload';
                content.textContent = JSON.stringify(lastResponsePayload, null, 2);
            }

            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('payload-modal').classList.remove('show');
        }

        // Close modal on background click
        document.getElementById('payload-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Page Navigation
        function showPage(page) {
            document.getElementById('shipment-page').style.display = page === 'shipment' ? 'block' : 'none';
            document.getElementById('ratecard-page').style.display = page === 'ratecard' ? 'block' : 'none';
            
            if (page === 'ratecard') {
                loadRateCardTable();
            }
        }

        // Rate Card Functions
        function loadRateCardTable() {
            const tbody = document.getElementById('rate-table-body');
            tbody.innerHTML = '';

            rateCard.forEach((tier, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--border)';
                row.innerHTML = `
                    <td style="padding: 1rem;">
                        <input type="number" 
                               value="${tier.weight}" 
                               step="0.01" 
                               min="0.01"
                               onchange="updateRateTier(${index}, 'weight', this.value)"
                               style="width: 120px; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                    </td>
                    <td style="padding: 1rem;">
                        <input type="number" 
                               value="${tier.price}" 
                               step="0.01" 
                               min="0"
                               onchange="updateRateTier(${index}, 'price', this.value)"
                               style="width: 120px; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <button onclick="deleteRateTier(${index})" class="btn-secondary" style="padding: 8px 16px; border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); cursor: pointer;">
                            üóëÔ∏è Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateRateTier(index, field, value) {
            rateCard[index][field] = parseFloat(value);
        }

        function addRateTier() {
            const lastTier = rateCard[rateCard.length - 1];
            const newWeight = lastTier ? lastTier.weight + 1 : 1;
            const newPrice = lastTier ? lastTier.price : 1.19;
            
            rateCard.push({ weight: newWeight, price: newPrice });
            loadRateCardTable();
        }

        function deleteRateTier(index) {
            if (confirm('Are you sure you want to delete this tier?')) {
                rateCard.splice(index, 1);
                loadRateCardTable();
            }
        }

        function saveRateCard() {
            // Sort by weight
            rateCard.sort((a, b) => a.weight - b.weight);
            localStorage.setItem('rateCard', JSON.stringify(rateCard));
            loadRateCardTable();
            alert('‚úÖ Rate card saved successfully!');
        }

        function resetRateCard() {
            if (confirm('Reset rate card to default values?')) {
                rateCard = [...DEFAULT_RATE_CARD];
                localStorage.setItem('rateCard', JSON.stringify(rateCard));
                loadRateCardTable();
                alert('‚úÖ Rate card reset to default!');
            }
        }

        function calculateRateFromCard(weight) {
            // Find the appropriate tier (weight not over)
            for (let tier of rateCard) {
                if (weight <= tier.weight) {
                    return tier.price;
                }
            }
            // If over all tiers, use the last tier's price
            return rateCard[rateCard.length - 1].price;
        }
    </script>
</body>
</html>
